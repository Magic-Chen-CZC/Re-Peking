<view class="community-container">
  <!-- Tabletop Texture -->
  <view class="tabletop-texture"></view>

  <!-- Header -->
  <view class="header">
    <view class="header-title">Travel Log</view>
    <view class="header-subtitle">TABLETOP MODE â€¢ {{posts.length}} ITEMS</view>
  </view>

  <!-- Loading Indicator -->
  <view class="loading-indicator {{isRefreshing ? 'active' : ''}}">
    <view class="spinner"></view>
  </view>

  <!-- Scrollable Table -->
  <scroll-view 
    scroll-y 
    class="table-scroll" 
    enable-back-to-top
    refresher-enabled="true"
    refresher-triggered="{{isRefreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
    scrollbar-hidden="{{true}}"
  >
    <view class="posts-wrapper">
      <block wx:for="{{posts}}" wx:key="id">
        <scattered-ticket 
          post="{{item}}" 
          index="{{index}}" 
          layoutConfig="{{layoutConfigs[index]}}"
          isFocused="{{focusedIndex === index}}"
          bind:click="handlePostClick"
          bind:longpress="handlePostLongPress"
        ></scattered-ticket>
      </block>
      
      <!-- Bottom Spacer -->
      <view class="bottom-spacer">
        <view class="spacer-line"></view>
      </view>
    </view>
  </scroll-view>

  <!-- Floating Publish Button -->
  <view class="fab-btn" bindtap="openPublishModal">
    <view class="fab-icon">+</view>
  </view>

  <!-- Publish Modal -->
  <view wx:if="{{showPublishModal}}" class="modal-overlay" bindtap="closePublishModal">
    <view class="modal-content publish-modal" catchtap="noop">
      <view class="modal-handle"></view>
      <view class="modal-header">
        <view class="close-btn" bindtap="closePublishModal">Ã—</view>
        <view class="modal-title">åˆ†äº«åˆ°ç¤¾åŒº</view>
        <view class="publish-btn" bindtap="handleSubmitPost">å‘å¸ƒ</view>
      </view>
      
      <scroll-view 
        scroll-y 
        class="modal-body"
        enhanced="{{true}}"
        show-scrollbar="{{false}}"
        scrollbar-hidden="{{true}}"
      >
        <!-- åœ°ç‚¹ä¿¡æ¯ï¼ˆä¸‹æ‹‰é€‰æ‹©å†å²è¡Œç¨‹ï¼‰ -->
        <view class="form-section">
          <view class="section-label">
            <text class="label-icon">ğŸ“</text>
            <text class="label-text">åœ°ç‚¹ä¿¡æ¯</text>
            <text class="required-mark">*</text>
          </view>
          <view wx:if="{{newPost.lockTripSelection}}" class="picker-locked">
            <text>{{newPost.tripLabel || 'æœ¬æ¬¡è¡Œç¨‹'}}</text>
          </view>
          <picker 
            wx:else
            mode="selector" 
            range="{{tripHistoryLabels}}" 
            value="{{selectedTripIndex}}"
            bindchange="handleTripPickerChange"
          >
            <view class="picker-field">
              <text>{{tripHistoryLabels[selectedTripIndex] || 'è¯·é€‰æ‹©å†å²è¡Œç¨‹'}}</text>
            </view>
          </picker>
          <text class="picker-hint">ä»…å±•ç¤ºä½ è¿‡å¾€çš„è¡Œç¨‹è®°å½•</text>
        </view>

        <!-- å›¾ç‰‡ä¸Šä¼ ï¼ˆå¯é€‰ï¼‰ -->
        <view class="form-section" bindtap="handleImageUpload">
          <view class="section-label">
            <text class="label-icon">ğŸ“·</text>
            <text class="label-text">å°é¢å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</text>
          </view>
          <block wx:if="{{newPost.imageUrl}}">
            <image src="{{newPost.imageUrl}}" mode="aspectFill" class="uploaded-image"></image>
          </block>
          <block wx:else>
            <view class="upload-placeholder">
              <view class="upload-icon">ğŸ“·</view>
              <text>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</text>
            </view>
          </block>
        </view>

        <!-- æ ‡é¢˜è¾“å…¥ -->
        <view class="form-section">
          <view class="section-label">
            <text class="label-icon">ğŸ“</text>
            <text class="label-text">æ ‡é¢˜</text>
            <text class="required-mark">*</text>
          </view>
          <input 
            class="input-title" 
            placeholder="ç»™ä½ çš„æ—…ç¨‹èµ·ä¸ªæ ‡é¢˜..." 
            placeholder-class="placeholder" 
            bindinput="handleTitleInput" 
            value="{{newPost.title}}" 
          />
        </view>

        <!-- æ„Ÿæƒ³è¾“å…¥ -->
        <view class="form-section">
          <view class="section-label">
            <text class="label-icon">ğŸ’­</text>
            <text class="label-text">æ—…è¡Œæ„Ÿæƒ³</text>
            <text class="required-mark">*</text>
          </view>
          <textarea 
            class="input-content" 
            placeholder="åˆ†äº«ä½ çš„æ—…è¡Œæ„Ÿå—å’Œå¿ƒå¾—..." 
            placeholder-class="placeholder" 
            bindinput="handleContentInput" 
            value="{{newPost.content}}" 
            maxlength="-1" 
            auto-height
          ></textarea>
        </view>
      </scroll-view>
    </view>
  </view>



  <!-- Detail Modal -->
  <view wx:if="{{selectedPost}}" class="modal-overlay" bindtap="closeModal">
    <view class="modal-content detail-modal" catchtap="noop">
      <view class="modal-handle"></view>
      
      <!-- Sticky Header -->
      <view class="modal-header">
        <view class="header-btn" bindtap="closeModal">è¿”å›</view>
        <view class="header-title">æ–‡ç« è¯¦æƒ…</view>
        <view class="header-spacer"></view>
      </view>

      <scroll-view 
        scroll-y 
        class="modal-body detail-body"
        enhanced="{{true}}"
        show-scrollbar="{{false}}"
        scrollbar-hidden="{{true}}"
      >
        <!-- ä¸»å›¾ -->
        <view class="detail-hero">
          <image src="{{selectedPost.imageUrl}}" mode="aspectFill" class="detail-hero-image"></image>
          <view class="detail-hero-tag">
            <text class="hero-tag-text">ä¸»å›¾</text>
          </view>
        </view>

        <!-- æ ‡é¢˜ -->
        <view class="detail-title">{{selectedPost.title}}</view>

        <!-- ç®€ä»‹ -->
        <view class="detail-intro">{{selectedPost.reflection}}</view>

        <!-- åœ°ç‚¹ä¿¡æ¯ -->
        <view class="detail-section">
          <view class="detail-section-header">
            <text class="detail-section-title">åœ°ç‚¹ä¿¡æ¯</text>
            <text class="detail-section-subtitle">{{detailStopsTotal}} ä¸ªåœ°ç‚¹</text>
          </view>

          <!-- åœ°ç‚¹è¯¦æƒ… -->
          <view class="detail-stops-block">
            <view class="detail-section-line">
              <text class="detail-section-label">æ™¯ç‚¹åˆ—è¡¨</text>
              <view class="detail-section-action" bindtap="toggleStopsExpanded">
                {{detailStopsExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}
              </view>
            </view>
            <view class="detail-stop-cards">
              <block wx:for="{{detailStopsDisplay}}" wx:key="seq">
                <view class="detail-stop-card">
                  <view class="detail-stop-header">
                    <text class="detail-stop-name">{{item.name}}</text>
                    <text class="detail-stop-seq">ç¬¬{{item.seq}}ç«™</text>
                  </view>
                  <view wx:if="{{item.aiSummary}}" class="detail-stop-ai">
                    <text class="detail-stop-label">AI æ€»ç»“</text>
                    <text class="detail-stop-text">{{item.aiSummary}}</text>
                  </view>
                  <view class="detail-stop-memories">
                    <text class="detail-stop-label">è®°å¿†ç‚¹</text>
                    <view wx:if="{{item.userLogs && item.userLogs.length > 0}}" class="detail-stop-logs">
                      <block wx:for="{{item.userLogs}}" wx:key="*this">
                        <text class="detail-log-item">â€¢ {{item}}</text>
                      </block>
                    </view>
                    <text wx:else class="detail-stop-empty">æš‚æ— è®°å½•</text>
                  </view>
                </view>
              </block>
            </view>
            <view wx:if="{{detailStopsTotal > detailStopsDisplay.length}}" class="detail-section-more" bindtap="toggleStopsExpanded">
              <text>{{detailStopsExpanded ? 'æ”¶èµ·åœ°ç‚¹è¯¦æƒ…' : 'å±•å¼€å…¨éƒ¨åœ°ç‚¹'}}</text>
            </view>
          </view>
        </view>

        <!-- è¯„è®ºåŒº -->
        <view class="detail-section detail-comments-section">
          <view class="detail-section-header">
            <view class="detail-section-heading">
              <text class="detail-section-title">è¯„è®ºåŒº</text>
              <text class="detail-section-subtitle">{{selectedPost.commentCount || 0}} æ¡</text>
            </view>
            <view class="detail-comments-actions">
              <view class="detail-like-btn {{selectedPost.liked ? 'liked' : ''}}" bindtap="toggleLike">
                <text>â™¥</text>
                <text class="detail-like-count">{{selectedPost.likeCount || 0}}</text>
              </view>
              <view class="detail-section-action" bindtap="toggleCommentInput">å†™è¯„è®º</view>
            </view>
          </view>
          <block wx:if="{{selectedPost.comments && selectedPost.comments.length > 0}}">
            <view class="detail-comments-list">
              <block wx:for="{{selectedPost.comments}}" wx:key="id">
                <view class="detail-comment-item">
                  <text class="detail-comment-user">{{item.user}}</text>
                  <text class="detail-comment-text">{{item.text}}</text>
                </view>
              </block>
            </view>
          </block>
          <block wx:else>
            <view class="detail-empty-comments">æš‚æ— è¯„è®ºï¼Œæˆä¸ºç¬¬ä¸€ä¸ªç•™è¨€çš„äººå§ã€‚</view>
          </block>
          <view wx:if="{{detailShowCommentInput}}" class="detail-comment-input-area">
            <input class="detail-comment-input" placeholder="å†™ä¸‹ä½ çš„æ—…è¡Œæ„Ÿæƒ³â€¦" bindinput="handleDetailCommentInput" value="{{detailCommentText}}" />
            <view class="detail-comment-send" bindtap="submitDetailComment">å‘é€</view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
